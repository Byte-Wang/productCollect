<div class="layui-fluid" id="stockChangeRecordContainer">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md12">
      <div class="layui-card">
        <div class="layui-card-body">
          <form class="layui-form layui-form-pane" lay-filter="stock-change-search-form" id="stock-change-search-form" style="margin-bottom:12px;">
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">创建时间</label>
                <div class="layui-input-inline" style="width:180px;">
                  <input type="text" id="stock-change-create-start-date" placeholder="开始时间" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">-</div>
                <div class="layui-input-inline" style="width:180px;">
                  <input type="text" id="stock-change-create-end-date" placeholder="结束时间" autocomplete="off" class="layui-input">
                </div>
              </div>

              <div class="layui-inline">
                <label class="layui-form-label">SKU</label>
                <div class="layui-input-inline" style="width:180px;">
                  <input type="text" id="stock-change-sku" placeholder="SKU" autocomplete="off" class="layui-input">
                </div>
              </div>

              <div class="layui-inline">
                <label class="layui-form-label">ASIN</label>
                <div class="layui-input-inline" style="width:180px;">
                  <input type="text" id="stock-change-asin" placeholder="ASIN" autocomplete="off" class="layui-input">
                </div>
              </div>

              <div class="layui-inline">
                <label class="layui-form-label">站点</label>
                <div class="layui-input-inline" style="width:180px;">
                  <input type="text" id="stock-change-region-name" placeholder="站点名称" autocomplete="off" class="layui-input">
                </div>
              </div>

              <div class="layui-inline">
                <label class="layui-form-label">店铺</label>
                <div class="layui-input-inline" style="width:180px;">
                  <input type="text" id="stock-change-store-name" placeholder="店铺名称" autocomplete="off" class="layui-input">
                </div>
              </div>

              <div class="layui-inline">
                <label class="layui-form-label">操作人</label>
                <div class="layui-input-inline" style="width:180px;">
                  <select id="stock-change-operator" name="operator_user_id" lay-search>
                    <option value="">全部</option>
                  </select>
                </div>
              </div>

              <div class="layui-inline">
                <label class="layui-form-label">变动次数</label>
                <div class="layui-input-inline" style="width:120px;">
                  <input type="number" id="stock-change-min-count" placeholder="最小次数" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-form-mid">-</div>
                <div class="layui-input-inline" style="width:120px;">
                  <input type="number" id="stock-change-max-count" placeholder="最大次数" autocomplete="off" class="layui-input">
                </div>
              </div>

              <div class="layui-inline">
                <button class="layui-btn" lay-submit lay-filter="stock-change-search-submit" id="stock-change-search-btn">查询</button>
                <button class="layui-btn layui-btn-primary" id="stock-change-export-btn">导出</button>
              </div>
            </div>
          </form>

          <table class="layui-hide" id="stock-change-record-table" lay-filter="stock-change-record-table"></table>
          <div class="layui-card" id="stock-change-record-pagebar"></div>

          <script type="text/html" id="stockChangeBar">
            <a class="layui-btn layui-btn-xs" lay-event="detail">库存变化记录</a>
          </script>

          <script type="text/html" id="skuTpl">
            <span style="color:#1E9FFF;">{{ d.sku }}</span>
          </script>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentStockPageSize = 10;
let currentSort = {}; // 存储当前排序状态

function getStockChangeSearchParams(){
  var params = {};
  var start = document.getElementById('stock-change-create-start-date') ? document.getElementById('stock-change-create-start-date').value : '';
  var end = document.getElementById('stock-change-create-end-date') ? document.getElementById('stock-change-create-end-date').value : '';
  var sku = document.getElementById('stock-change-sku') ? document.getElementById('stock-change-sku').value : '';
  var asin = document.getElementById('stock-change-asin') ? document.getElementById('stock-change-asin').value : '';
  var regionName = document.getElementById('stock-change-region-name') ? document.getElementById('stock-change-region-name').value : '';
  var storeName = document.getElementById('stock-change-store-name') ? document.getElementById('stock-change-store-name').value : '';
  var operatorUserId = document.getElementById('stock-change-operator') ? document.getElementById('stock-change-operator').value : '';
  var minCount = document.getElementById('stock-change-min-count') ? document.getElementById('stock-change-min-count').value : '';
  var maxCount = document.getElementById('stock-change-max-count') ? document.getElementById('stock-change-max-count').value : '';

  if (start) params.created_time_start = start;
  if (end) params.created_time_end = end;
  if (sku) params.sku = sku;
  if (asin) params.asin = asin;
  if (regionName) params.region_name = regionName;
  if (storeName) params.store_name = storeName;
  if (operatorUserId !== '') params.operator_user_id = operatorUserId;
  if (minCount !== '') params.minCount = Number(minCount);
  if (maxCount !== '') params.maxCount = Number(maxCount);
  
  // 固定参数
  params.type = 2; // 库存变化记录
  
  // 添加排序参数
  if (currentSort.field === 'count' && currentSort.type) {
    params.order_by_count = currentSort.type;
  } else if (currentSort.field === 'created_time' && currentSort.type) {
    params.order_by_time = currentSort.type;
  }
  
  return params;
}

function renderStockChangeRecordTable(params){
  var table = layui.table;
  var laypage = layui.laypage;
  if (params.type != 'export') {
    currentStockPageSize = params.limit;
  }

  if (params.type == 'export') {
    var exportParams = Object.assign({}, params);
    // 导出时如果不带 group_by_sku，可能会导出明细
    // 如果想要导出一级列表，需加上 group_by_sku=true
    // 这里默认按用户当前视图逻辑导出，如果用户在看一级列表，导出也应该是一级列表？
    // 但通常导出是为了看所有数据。
    // 假设导出不需要 group_by_sku
    
    getBlobRequest('/index/exportPriceChangeRecord', exportParams, function(response){
      try {
        if (response && response.blob) {
          const blob = new Blob([response.blob], {
            type: response.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
          });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = response.filename || '库存记录数据.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
          layer.msg('导出成功', { icon: 1, time: 2000 });
        } else {
          layer.msg(response && response.msg ? response.msg : '导出失败：返回数据格式错误', { icon: 2, time: 2000 });
        }
      } catch(e) {
        console.error('导出失败:', e);
        layer.msg('导出失败: ' + e.message, { icon: 2, time: 2000 });
      }
    });
    return;
  }

  // 主表查询，添加 group_by_sku=true
  var mainParams = Object.assign({}, params, { /*group_by_sku: false*/ });

  getRequest('/index/getPriceChangeRecord', mainParams, function(res){
    if (res.code != 1) {
      layer.msg(res.msg || '数据获取失败', {offset:'15px', icon:2, time:1000});
      return;
    }
    var cloudData = res.data || {list:[], total:0};

    table.render({
      elem: '#stock-change-record-table',
      data: cloudData.list,
      title: '库存记录数据',
      cellMinWidth: 60,
      page: false,
      limit: params.limit,
      cols: [[
        {field:'id', title:'ID', width:90},
        {field:'sku', title:'SKU', width:160, templet:'#skuTpl'},
        {field:'product_title', title:'产品标题', width:300},
        {field:'asin', title:'ASIN', width:120},
        {field:'region_name', title:'站点', width:160},
        {field:'stock', title:'最新库存', width:100},
        // {field:'count', title:'库存变化次数', width:130, sort: true},
        {field:'store_name', title:'店铺', width:160},
        {field:'operator_username', title:'操作人', width:120},
        {field:'created_time', title:'最近修改时间', width:160, sort: true},
        // {title: '操作', toolbar: '#stockChangeBar', width: 100, fixed: 'right'}
      ]],
      done: function(res, curr, count){
        // 
      }
    });

    laypage.render({
      elem: 'stock-change-record-pagebar',
      count: cloudData.total,
      curr: params.page,
      limit: params.limit,
      limits: [10,20,50,100],
      layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip'],
      jump: function(obj){
        var sp = getStockChangeSearchParams();
        if (params.page == obj.curr && params.limit == obj.limit) return;
        renderStockChangeRecordTable(Object.assign({}, sp, {page: obj.curr, limit: obj.limit}));
      }
    });
  });
}

layui.use(['table','form','laypage','laydate'], function(){
  var form = layui.form, laydate = layui.laydate, table = layui.table;

  laydate.render({ elem: '#stock-change-create-start-date', type: 'datetime' });
  laydate.render({ elem: '#stock-change-create-end-date', type: 'datetime' });

  function fillOperatorOptions(list){
    var sel = layui.$('#stock-change-operator');
    sel.empty();
    sel.append(new Option('全部', ''));
    list.forEach(function(user){
      sel.append(new Option(user.nickname, user.id));
    });
    form.render('select');
  }

  if (window.serviceData && Array.isArray(serviceData.authList) && serviceData.authList.length){
    fillOperatorOptions(serviceData.authList);
  } else if (typeof addListen === 'function') {
    addListen(function(key, value){
      if (key === 'authList' && Array.isArray(value)){
        fillOperatorOptions(value);
      }
    });
  }

  layui.$('#stock-change-export-btn').click(function(){
    var sp = getStockChangeSearchParams();
    renderStockChangeRecordTable(Object.assign({page: 1, limit: 99999, type: 'export'}, sp));
    return false;
  });

  form.on('submit(stock-change-search-submit)', function(){
    var sp = getStockChangeSearchParams();
    renderStockChangeRecordTable(Object.assign({page:1, limit: currentStockPageSize}, sp));
    return false;
  });
  
  // 监听排序事件
  table.on('sort(stock-change-record-table)', function(obj){
    currentSort = {field: obj.field, type: obj.type}; // 记录当前排序状态
    var sp = getStockChangeSearchParams();
    // 重新渲染表格，重置到第一页
    renderStockChangeRecordTable(Object.assign({page: 1, limit: currentStockPageSize}, sp));
    
    // 保持表头排序状态显示（因为 render 会重置表格）
    // layui table.render 后会自动根据 initSort 处理，但我们是重新请求数据。
    // 这里需要手动处理一下样式的同步，或者让 layui 自动处理（通常重新 render 后如果不指定 initSort，排序图标会消失）
    // 为了更好的体验，我们可以在 render 配置里加上 initSort: obj
  });

  // 监听工具条 - 展开/折叠逻辑
  table.on('tool(stock-change-record-table)', function(obj){
    var data = obj.data;
    if(obj.event === 'detail'){
      var tr = obj.tr; // 获得当前行 tr 的 DOM 对象
      var rowId = 'detail-row-' + data.id; // 生成唯一ID
      
      if(layui.$('#'+rowId).length > 0){
         // 已经展开，则折叠（移除）
         layui.$('#'+rowId).remove();
         return;
      }

      // 插入详情行
      // 计算列数
      var colspan = tr.find('td').length;
      var detailHtml = '<tr id="'+rowId+'" class="detail-row"><td colspan="'+colspan+'" style="padding: 10px; background-color: #f8f8f8;"><div style="padding: 10px; background: #fff; border: 1px solid #eee;"><h4 style="margin-bottom:10px;font-weight:bold;">SKU: '+data.sku+' 的库存变化记录</h4><table id="detail-table-'+data.id+'" lay-filter="detail-table-'+data.id+'"></table></div></td></tr>';
      tr.after(detailHtml);

      // 渲染详情表
      // 查询参数：保留原有查询条件的 type, 加上 sku, 去掉 group_by_sku
      var sp = getStockChangeSearchParams();
      // 移除 group_by_sku (虽然本身没有)
      // 添加 sku
      var detailParams = Object.assign({}, sp, {
         sku: data.sku,
         page: 1,
         limit: 20 // 默认只显示20条，子表可以不需要分页条，或者简单的分页
      });
      
      // 注意：这里没有 laypage，如果需要分页，得在子表下方再加一个pagebar容器，逻辑会变复杂。
      // 简单起见，子表暂时不显示分页条，或者显示一个简单的“只显示最近20条”提示。
      // 或者使用 table 自身的 page 参数开启前端分页？
      // 如果后端分页，则需要手动处理。
      // 鉴于“展开”通常用于快速查看，且用户没强调子表分页，我先用 table 自带的分页（如果数据量小）
      // 或者开启后端分页支持。
      // 为了简单，我开启 table 的 page: true，这通常是前端分页（如果 data 是一次性返回）
      // 如果 getRequest 返回的是分页数据 list, total
      
      getRequest('/index/getPriceChangeRecord', detailParams, function(res){
         if(res.code == 1){
            var detailData = res.data.list || [];
            table.render({
               elem: '#detail-table-' + data.id,
               data: detailData,
               page: false, // 暂时不分页，直接列表
               limit: 100, // 最多显示100条
               cols: [[
                  {field:'id', title:'ID', width:80},
                  {field:'original_price', title:'原价', width:100},
                  {field:'new_price', title:'新价', width:100},
                  {field:'stock', title:'库存', width:100},
                  {field:'sales_status', title:'售卖状态', width:120},
                  {field:'operator_username', title:'操作人', width:120},
                  {field:'created_time', title:'修改时间', width:160}
               ]]
            });
         } else {
            layer.msg('获取详情失败: ' + res.msg);
         }
      });
    }
  });

  renderStockChangeRecordTable(Object.assign({page:1, limit: currentStockPageSize}, getStockChangeSearchParams()));
});
</script>
